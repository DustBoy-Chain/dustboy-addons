#!/command/with-contenv bashio
# DA Server â€” retrieves Alt-DA blobs from S3-compatible storage (Cloudflare R2)

DA_S3_BUCKET=$(bashio::config 'da_s3_bucket')
DA_S3_ENDPOINT=$(bashio::config 'da_s3_endpoint')
DA_S3_ACCESS_KEY=$(bashio::config 'da_s3_access_key')
DA_S3_SECRET=$(bashio::config 'da_s3_secret')
LOG_LEVEL=$(bashio::config 'log_level')

# Fallback: read from da-env file if bashio config is empty
DA_ENV="/data/config/da-env"
if [ -z "${DA_S3_ENDPOINT}" ] && [ -f "${DA_ENV}" ]; then
    echo "[da-server] Reading credentials from ${DA_ENV}"
    . "${DA_ENV}"
fi

echo "[da-server] Starting DA server (bucket: ${DA_S3_BUCKET})"

exec da-server \
    --s3.bucket="${DA_S3_BUCKET}" \
    --s3.endpoint="${DA_S3_ENDPOINT}" \
    --s3.access-key-id="${DA_S3_ACCESS_KEY}" \
    --s3.access-key-secret="${DA_S3_SECRET}" \
    --addr=127.0.0.1 \
    --port=3100 \
    --log.level="${LOG_LEVEL}" \
    --generic-commitment=false
